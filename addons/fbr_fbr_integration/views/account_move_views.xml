<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <record id="fbr_di_view_move_form_inherit_final" model="ir.ui.view">
    <field name="name">account.move.form.fbr.di.final</field>
    <field name="model">account.move</field>
    <field name="inherit_id" ref="account.view_move_form"/>
    <field name="arch" type="xml">
      <!-- Header button + existing badge -->
      <xpath expr="//header" position="inside">
        <button name="action_send_to_fbr"
                type="object"
                string="Send to FBR"
                class="oe_highlight"
                modifiers="{'invisible': ['|', ['state','!=','posted'], ['move_type','not in', ['out_invoice','out_refund']]]}"
        />
        <field name="fbr_status" widget="badge" readonly="1"
               modifiers="{'invisible': [['fbr_status','=','not_sent']]}"
        />
      </xpath>

      <!-- FBR page (existing) -->
      <xpath expr="//sheet/notebook" position="inside">
        <page string="FBR Digital Invoicing">
          <group>
            <group string="Header">
              <field name="fbr_invoice_type"/>
              <field name="fbr_buyer_registration_type"/>
              <field name="fbr_invoice_ref_no"/>
              <field name="fbr_status" readonly="1"/>
              <field name="fbr_invoice_number" readonly="1"/>
              <field name="fbr_sent_at" readonly="1"/>
            </group>
            <group string="FBR Totals (Computed)">
              <field name="amount_extra_tax" readonly="1"/>
              <field name="amount_further_tax" readonly="1"/>
              <field name="amount_total_with_all" readonly="1"/>
            </group>
            <group string="Debug">
              <field name="fbr_request_payload" readonly="1" widget="text"/>
              <field name="fbr_last_response" readonly="1" widget="text"/>
              <field name="fbr_qr_text" readonly="1"/>
              <field name="fbr_qr_png" readonly="1" widget="image"/>
            </group>
          </group>
        </page>
      </xpath>

      <!-- Lines tree: show per-line extra/further (optional but useful) -->
      <xpath expr="//field[@name='invoice_line_ids']/tree" position="attributes">
        <attribute name="create">1</attribute>
        <attribute name="editable">bottom</attribute>
      </xpath>
      <xpath expr="//field[@name='invoice_line_ids']/tree" position="inside">
        <field name="fbr_extra_tax_amount" readonly="1"/>
        <field name="fbr_further_tax_amount" readonly="1"/>
        <field name="fbr_line_total_incl_all" readonly="1"/>
      </xpath>

    </field>
  </record>
</odoo>
